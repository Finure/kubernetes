name: Kubernetes API Validation

on:
  pull_request:
    paths:
      - '**.yaml'
      - '**.yml'

jobs:
  validate:
    name: Validate YAML and HelmReleases
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 

      - name: Install tools (helm, kubeconform, yq)
        run: |
          curl -L https://get.helm.sh/helm-v3.14.3-linux-amd64.tar.gz | tar xz
          sudo mv linux-amd64/helm /usr/local/bin/

          curl -L https://github.com/yannh/kubeconform/releases/latest/download/kubeconform-linux-amd64.tar.gz | tar xz
          sudo mv kubeconform /usr/local/bin/

          YQ_VERSION="v4.40.5"
          curl -L "https://github.com/mikefarah/yq/releases/download/${YQ_VERSION}/yq_linux_amd64" -o yq
          chmod +x yq
          sudo mv yq /usr/local/bin/yq

      - name: chmod validation script
        run: chmod +x .github/scripts/validate.sh

      - name: Validate changed manifests
        run: .github/scripts/validate.sh
